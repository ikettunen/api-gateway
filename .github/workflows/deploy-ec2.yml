# API Gateway deployment workflow for EC2 self-hosted runner
# Deploys Node.js service to EC2 and restarts with PM2

name: Deploy API Gateway to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js 22
      uses: actions/setup-node@v3
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: Verify Node.js version
      run: |
        node --version
        npm --version
    
    - name: Install dependencies
      run: npm ci
    
    - name: Deploy to EC2
      run: |
        # Backup current version
        if [ -d ~/api-gateway ]; then
          cp -r ~/api-gateway ~/api-gateway.backup
        fi
        
        # Copy new files (excluding node_modules and .git)
        rsync -av --exclude='node_modules' --exclude='.git' --exclude='logs' ./ ~/api-gateway/
        
        # Install dependencies in target directory
        cd ~/api-gateway
        npm install --production
        
        echo "Deployed to ~/api-gateway"
    
    - name: Restart service with PM2
      run: |
        cd ~/api-gateway
        pm2 restart api-gateway || pm2 start src/server.js --name api-gateway
        pm2 save
    
    - name: Deployment Summary
      run: |
        echo "‚úÖ API Gateway deployed successfully!"
        echo "üåê Service URL: http://51.20.164.143:3001"
        echo "üìÅ Deployed to: ~/api-gateway"
        echo ""
        echo "PM2 Status:"
        pm2 list | grep api-gateway
